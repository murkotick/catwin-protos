syntax = "proto3";

package catwin.user.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/murkotick/catwin-protos/gen/go/user";

service UserService {
	rpc Register(RegisterRequest) returns (RegisterResponse);
	rpc Login(LoginRequest) returns (LoginResponse);
	
	rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);

	rpc Logout(LogoutRequest) returns (LogoutResponse);

	rpc GetUser(GetUserRequest) returns (GetUserResponse);

	rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);

	rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);
}

message User {
	string user_id = 1;
	string email = 2;
	string username = 3;

	UserStatus status = 4;

	google.protobuf.Timestamp created_at = 5;
	google.protobuf.Timestamp last_login_at = 6;
}

enum UserStatus {
	USER_STATUS_ACTIVE = 0;
	USER_STATUS_DELETED = 1;
}

message TokenPair {
	string access_token = 1;
	string refresh_token = 2;

	google.protobuf.Timestamp access_token_expires_at = 3;
	google.protobuf.Timestamp refresh_token_expires_at = 4;
}

message RegisterRequest {
	string email = 1;
	string password = 2;

	string username = 3;

	string idempotency_key = 4;
}

message RegisterResponse {
	User user = 1;

	TokenPair tokens = 2;
}

message LoginRequest {
	string email = 1;

	string password = 2;
}

message LoginResponse {
	User user = 1;

	TokenPair tokens = 2;
}

message RefreshTokenRequest {
	string refresh_token = 1;
}

message RefreshTokenResponse {
	TokenPair tokens = 1;
}

message LogoutRequest {
	string user_id = 1;

	string refresh_token = 2;

	// Usefull for a "log out everywhere" feature
	bool revoke_all_tokens = 3;
}

message LogoutResponse {
	bool success = 1;
}

message GetUserRequest {
	string user_id = 1;
}

message GetUserResponse {
	User user = 1;
}

message ValidateTokenRequest {
	string access_token = 1;
}

message ValidateTokenResponse {
	bool valid = 1;

	User user = 2;

	map<string, string> claims = 3;

	string error_code = 4;
}

message DeleteUserRequest {
	string user_id = 1;
	string password = 2;

	string reason = 3;
}

message DeleteUserResponse {
	bool success = 1;

	google.protobuf.Timestamp permanent_deletion_at = 2;
}